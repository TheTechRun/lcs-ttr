<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Content Share TTR</title>
    <link rel="stylesheet" href="/static/fontawesome/css/all.min.css">
    <link href="/static/css/inter.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#cba6f7"> <!-- mauve:dark -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ContentShareTTR">
    <meta name="format-detection" content="telephone=no">

    <style>
        :root { /* Catppuccin Latte (Light Theme) */
            --rosewater: #dc8a78; --flamingo: #dd7878; --pink: #ea76cb;
            --mauve: #8839ef; --red: #d20f39; --maroon: #e64553;
            --peach: #fe640b; --yellow: #df8e1d; --green: #40a02b;
            --teal: #179299; --sky: #04a5e5; --sapphire: #209fb5;
            --blue: #1e66f5; --lavender: #7287fd; --text: #4c4f69;
            --subtext1: #5c5f77; --subtext0: #6c6f85; --overlay2: #7c7f93;
            --overlay1: #8c8fa1; --overlay0: #9ca0b0; --surface2: #acb0be;
            --surface1: #bcc0cc; --surface0: #ccd0da; --base: #eff1f5;
            --mantle: #e6e9ef; --crust: #dce0e8;
        }

        html.dark { /* Catppuccin Mocha (Dark Theme) */
            --rosewater: #f5e0dc; --flamingo: #f2cdcd; --pink: #f5c2e7;
            --mauve: #cba6f7; --red: #f38ba8; --maroon: #eba0ac;
            --peach: #fab387; --yellow: #f9e2af; --green: #a6e3a1;
            --teal: #94e2d5; --sky: #89dceb; --sapphire: #74c7ec;
            --blue: #89b4fa; --lavender: #b4befe; --text: #cdd6f4;
            --subtext1: #bac2de; --subtext0: #a6adc8; --overlay2: #9399b2;
            --overlay1: #7f849c; --overlay0: #6c7086; --surface2: #585b70;
            --surface1: #45475a; --surface0: #313244; --base: #1e1e2e;
            --mantle: #181825; --crust: #11111b;
        }
    </style>
    <script>
        // Immediately apply theme to prevent FOUC
        (function() {
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            applyTheme(mediaQuery.matches ? 'dark' : 'light');
            mediaQuery.addEventListener('change', (e) => {
                applyTheme(e.matches ? 'dark' : 'light');
            });
        })();
    </script>
    <script src="/static/js/tailwindcss.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    borderRadius: {
                        '4xl': '2rem',
                    },
                    colors: {
                        'rosewater': 'var(--rosewater)', 'flamingo': 'var(--flamingo)',
                        'pink': 'var(--pink)', 'mauve': 'var(--mauve)',
                        'red': 'var(--red)', 'maroon': 'var(--maroon)',
                        'peach': 'var(--peach)', 'yellow': 'var(--yellow)',
                        'green': 'var(--green)', 'teal': 'var(--teal)',
                        'sky': 'var(--sky)', 'sapphire': 'var(--sapphire)',
                        'blue': 'var(--blue)', 'lavender': 'var(--lavender)',
                        'text': 'var(--text)', 'subtext1': 'var(--subtext1)',
                        'subtext0': 'var(--subtext0)', 'overlay2': 'var(--overlay2)',
                        'overlay1': 'var(--overlay1)', 'overlay0': 'var(--overlay0)',
                        'surface2': 'var(--surface2)', 'surface1': 'var(--surface1)',
                        'surface0': 'var(--surface0)', 'base': 'var(--base)',
                        'mantle': 'var(--mantle)', 'crust': 'var(--crust)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-crust text-text antialiased transition-colors duration-300">
<div class="container mx-auto max-w-6xl p-4 sm:p-6 lg:p-8">

    <header class="text-center mb-8 relative">
        <h1 class="text-3xl sm:text-4xl font-bold text-mauve">Local Content Share TTR</h1>
        <form action="/logout" method="POST" class="absolute right-0 top-1/2 -translate-y-1/2">
            <button type="submit" class="flex items-center gap-2 px-3 py-2 bg-base hover:bg-surface0 rounded-xl transition-colors">
                <i class="fas fa-sign-out-alt text-subtext0"></i>
                <span class="font-medium text-sm text-subtext0 hidden sm:inline">Logout</span>
            </button>
        </form>
    </header>

    <main class="flex flex-col gap-8">
        <section class="w-full">
            <div class="flex flex-wrap items-center justify-center gap-3 mb-6">
                <button id="new-category-button" type="button"
                    class="flex items-center gap-2 px-4 py-2 bg-base hover:bg-surface0 rounded-xl cursor-pointer transition-colors">
                    <i class="fas fa-folder-plus text-subtext0"></i>
                    <span class="font-medium text-sm text-subtext0">New Category</span>
                </button>
                <a href="/md" class="flex items-center gap-2 px-4 py-2 bg-base hover:bg-surface0 rounded-xl transition-colors no-underline">
                    <i class="fas fa-note-sticky text-subtext0"></i>
                    <span class="font-medium text-sm text-subtext0">Notepad</span>
                </a>
            </div>
        </section>

        <section>
            {{if not .Categories}}
            <p class="text-center text-subtext0 py-12">No categories yet. Create one to get started.</p>
            {{else}}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {{range .Categories}}
                <a href="/c/{{.Name}}" class="block bg-base border border-transparent hover:border-surface1 rounded-3xl px-5 py-4 transition-colors group no-underline relative">
                    <div class="flex items-start justify-between">
                        <div class="min-w-0">
                            <h3 class="text-lg font-semibold text-text truncate">{{.Name}}</h3>
                            <p class="text-sm text-subtext0 mt-1">
                                {{if eq .TotalCount 0}}Empty
                                {{else}}
                                    {{if .FileCount}}{{.FileCount}} file{{if gt .FileCount 1}}s{{end}}{{end}}
                                    {{if and .FileCount .TextCount}} · {{end}}
                                    {{if .TextCount}}{{.TextCount}} snippet{{if gt .TextCount 1}}s{{end}}{{end}}
                                    {{if and (or .FileCount .TextCount) .LinkCount}} · {{end}}
                                    {{if .LinkCount}}{{.LinkCount}} link{{if gt .LinkCount 1}}s{{end}}{{end}}
                                {{end}}
                            </p>
                        </div>
                        <button onclick="event.preventDefault(); event.stopPropagation(); deleteCategory('{{.Name}}')"
                            class="opacity-0 group-hover:opacity-100 ml-2 flex-shrink-0 w-8 h-8 flex items-center justify-center bg-base hover:bg-surface0 text-subtext0 rounded-full transition-all"
                            title="Delete category">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                </a>
                {{end}}
            </div>
            {{end}}
        </section>
    </main>
</div>

<!-- New Category Modal -->
<div id="new-category-modal" class="hidden fixed inset-0 bg-overlay2/70 dark:bg-black/70 flex items-center justify-center max-w-full p-4 z-50">
    <div id="new-category-backdrop" class="absolute inset-0"></div>
    <div class="bg-crust rounded-3xl p-6 w-full max-w-md z-10">
        <h3 class="text-lg font-medium text-text mb-4">New Category</h3>
        <form action="/category/create" method="POST">
            <input type="text" name="name" required
                placeholder="Category name (letters, numbers, hyphens)"
                pattern="[\p{L}\p{N}\-_]+"
                title="Letters, numbers, hyphens and underscores only"
                class="w-full bg-base px-4 py-3 text-text placeholder-overlay1 focus:outline-none rounded-2xl mb-6">
            <div class="flex justify-end gap-4">
                <button type="button" id="new-category-cancel"
                    class="px-4 py-2 bg-base hover:bg-surface0 text-subtext0 rounded-xl transition-colors font-medium">Cancel</button>
                <button type="submit"
                    class="px-4 py-2 bg-blue hover:bg-sapphire text-crust font-semibold rounded-xl transition-colors">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal" class="hidden fixed inset-0 bg-overlay2/70 dark:bg-black/70 flex items-center justify-center max-w-full p-4 z-50">
    <div class="bg-crust rounded-3xl p-6 w-full max-w-sm z-10 text-center">
        <h3 id="confirmation-title" class="text-lg font-medium text-text mb-4">Are you sure?</h3>
        <p id="confirmation-message" class="text-sm text-subtext1 mb-6">This action cannot be undone.</p>
        <div class="flex justify-center gap-4">
            <button id="confirm-cancel-button" class="px-4 py-2 bg-base hover:bg-surface0 text-subtext0 rounded-xl transition-colors font-medium">Cancel</button>
            <button id="confirm-action-button" class="px-4 py-2 bg-red hover:bg-maroon text-crust font-semibold rounded-xl transition-colors">Delete</button>
        </div>
    </div>
</div>

<script>
    // PWA Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(() => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }

    document.getElementById('new-category-button').addEventListener('click', () => {
        document.getElementById('new-category-modal').classList.remove('hidden');
    });
    document.getElementById('new-category-cancel').addEventListener('click', () => {
        document.getElementById('new-category-modal').classList.add('hidden');
    });
    document.getElementById('new-category-backdrop').addEventListener('click', () => {
        document.getElementById('new-category-modal').classList.add('hidden');
    });

    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const confirmActionButton = document.getElementById('confirm-action-button');
    let confirmCallback = null;

    function showConfirmation(callback, title = 'Are you sure?', message = 'This action cannot be undone.') {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        confirmationModal.classList.remove('hidden');
        confirmCallback = callback;
    }

    confirmCancelButton.addEventListener('click', () => {
        confirmationModal.classList.add('hidden');
        confirmCallback = null;
    });

    confirmActionButton.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback();
        }
        confirmationModal.classList.add('hidden');
        confirmCallback = null;
    });

    function deleteCategory(name) {
        showConfirmation(() => {
            fetch('/category/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'name=' + encodeURIComponent(name)
            }).then(r => {
                if (r.ok) {
                    window.location.reload();
                } else {
                    console.error('Failed to delete category');
                }
            }).catch(e => console.error('Error:', e));
        }, 'Delete Category?', `Delete "${name}" and ALL its contents? This cannot be undone.`);
    }

    // SSE for live updates
    let evtSource;
    function connectSSE() {
        if (evtSource) {
            evtSource.close();
        }
        evtSource = new EventSource('/api/updates');
        evtSource.onmessage = function(event) {
            if (event.data === 'content_updated') {
                const isModalOpen = document.querySelector('#new-category-modal:not(.hidden), #confirmation-modal:not(.hidden)');
                if (!isModalOpen) {
                    setTimeout(() => { window.location.reload(); }, 250);
                }
            }
        };
        evtSource.onerror = function() {
            console.log('SSE connection error. Will attempt to reconnect.');
            evtSource.close();
        };
    }

    window.addEventListener('load', function() {
        connectSSE();
    });

    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && (!evtSource || evtSource.readyState === EventSource.CLOSED)) {
            connectSSE();
        }
    });
</script>
</body>
</html>
